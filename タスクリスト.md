StraightBar Lite – Visual タスクリスト（v0.2.3-robust基準）

目的
屋外での手動直進をより確実・見やすくするための機能拡張と安定化。

進行順（実装フェーズ）
フェーズ1：最短で体験が向上する項目
1. 最寄ライン（実装）
   - 意味: 現在位置に最も近い並行ラインへターゲットをスナップ。
   - 仕様: ct.perp を作業幅で割って四捨五入 → n=round(ct.perp/作業幅)。ボタン押下で currentLineIndex=n に設定。A/Bが無効・AB<5m時は警告。
   - UI: 「最寄ライン」ボタンで即時反映。ヒント文更新。
   - DoD: ボタン1回でターゲットラインが最寄へ切替。横ズレ/ヒントが即時に一致。

2. 画面常時ON（実装）
   - 意味: 走行中に画面が消えないようにする。
   - 仕様: Screen Wake Lock API (navigator.wakeLock.request('screen')) を使用。計測開始時にON、停止時とページ非表示時/アンロード時にrelease。非対応端末はヒント表示。
   - UI: 「画面常時ON」ボタンでON/OFFトグル表示（ON/OFF表記）。
   - DoD: 対応端末でスリープしない。非対応端末はガイダンス表示。停止で確実に解除。

3. 針路更新（実装）
   - 意味: ヘッダーの針路(°)を実際の進行方向で更新。
   - 仕様: pos.coords.heading が有効かつ速度>0.5m/sなら採用。無効時は直近2点の座標差で方位角（0–359°、北=0）を算出。低速時は更新抑制。
   - DoD: 低速時に跳ねない。移動時に針路が自然に変化。

フェーズ2：使い勝手の向上と安定運用
4. 音声ガイダンス（実装）
   - 意味: 画面を見ずに左右ズレを音で案内。
   - 仕様: SpeechSynthesisを使用。閾値（例 ±0.30m）とヒステリシス（±0.25/±0.35）＋クールダウン（≥2.5秒）。「音声: ON/OFF」ボタンで切替。
   - DoD: 過剰発話がない。左右と量が正しく読み上げられる。

5. 設定の永続化（実装）
   - 対象: 作業幅、currentLineIndex、音声ON/OFF、（任意）画面常時ONの希望。
   - 仕様: localStorage へ保存/復元。A/Bは誤用防止のためセッション越えの永続化はしない（任意でオプション化）。
   - DoD: 再起動後に設定が復元される。UI表示と内部状態が一致。

6. 自動復帰（watch→polling→watch）（実装）
   - 意味: 取得が止まれば自動でpollingへ、安定したら自動でwatchに戻す。
   - 仕様: watchで5秒無更新→polling。pollingで連続10回成功（約10秒）でwatch再開。失敗なら再度polling。モード表示更新。
   - DoD: ユーザー操作なしで適切に行き来し、ログに状態遷移が残る。

フェーズ3：中期（任意）
7. 可視レンジ自動スケール
   - 仕様: 作業幅と現在のoffsetの最大値を見て、Viz表示レンジ（±m）を2〜3段階で可変。

8. 走行履歴トレース/CSVエクスポート
   - 仕様: 時刻, lat, lon, offset, speed, acc, mode を記録し、手動エクスポート。

9. PWAオフライン対応（簡易SW）
   - 仕様: キャッシュ名にバージョンを持たせ、更新時に自動切替。nocache版は維持。

10. 外部GNSS（BLE/NMEA）検証
   - Android: 「外部GNSSに接続」ボタン→GATTでNMEA受信→$GGA/$RMCパース→既存更新パイプへ流す。切断時はgeolocationへ戻す。
   - iOS: Core Location統合型GNSSでSafariのgeolocationが高精度化される実機検証（アプリ側変更なし）。

作業メモ（実装ノート）
- ライン番号計算: n = Math.round(ct.perp / 作業幅)
- 針路角計算: θ = atan2(Δx, Δy) を 0–360°へ正規化（北=0、時計回り）
- Wake Lock: 可視状態やページ遷移で必ずrelease。例外はtry/catchでログ。
- 音声: 連呼防止のクールダウンとヒステリシスを併用。発話中は次の発話を抑制。

直近の次アクション（この順）
- [ ] 最寄ラインの実装
- [ ] 画面常時ON（Wake Lock）
- [ ] 針路更新（heading/差分方位）
- [ ] 音声ガイダンス（閾値/ヒステリシス/クールダウン）
- [ ] 設定永続化（localStorage）
- [ ] 自動復帰（watch→polling→watch）


