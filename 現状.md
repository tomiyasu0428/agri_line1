StraightBar Lite – Visual：現場テストまとめ（概要＆課題）
1) なにを作ってる？
目的：屋外作業で「まっすぐ」を維持するために、左右のズレだけを大きく見せるガイダンス。

方式：スマホのブラウザ/PWAで動作（BYOD）。まずはスマホ内蔵GPSで“目安”利用、将来は**Bluetooth外部GNSS（NMEA）**にも対応予定。

対象：軽トラ・トラクタの手動直進補助、散布の重複/漏れ低減など。

2) 直近のビルドと違い
v0.2.0（初期）
ABライン・スワス幅・最寄ラインなど基本機能。

v0.2.2（現行安定）

ヘッダーに 「更新: 〜Hz」（位置更新レート）を追加

A→現在距離の表示

AB距離<5mは警告＋横ズレ計算停止（向きが決まらないため）

v0.2.3-debug（切り分け用）
受信回数・最終更新時刻・実測Hzを表示して、端末/ブラウザの問題を特定しやすく。

v0.2.3-robust（改善案）
watchPositionが止まったら自動で毎秒ポーリングへフォールバック。ヘッダーに**モード（watch/polling）**を表示。
※Service Workerなし版も用意（キャッシュ影響ゼロの検証用）。

3) 現場での使い方（テスト手順）
URLを開く：デプロイ直後は ?v=タイムスタンプ を付けてキャッシュ回避。

計測開始 を押す（停止ボタンが有効になればOK）。

A点→（10〜30m直進）→B点 を設定。ログにAB距離が10m以上と出ること。

最寄ライン を1回タップ。

ヘッダー確認：

精度：10〜15m以下が望ましい

更新：おおむね 1.0〜2.0Hz

速度：移動に応じて変化

必要に応じてホーム画面へ追加（更新後はいったん削除→再追加が確実）。

4) 今回出た主な問題と対策
A. 旧版が表示される（更新: Hzが出ない／UIが古い）
原因：Service WorkerとHTTPキャッシュ。

対策：

新しいパス（フォルダ）にデプロイ、またはnocache版を使用

URLに ?v=数字 を付与

PWAを削除→Safariで最新確認→再追加

SWを使う場合は キャッシュ名にバージョンを入れて毎回更新

B. 位置が「最初の1回だけ」来て、その後止まる（更新: -Hzのまま）
症状：速度が変わらない／AB距離が0mのまま。

想定原因：iOS Safariで watchPosition が稀に継続更新しない事象。低電力や権限設定、屋内も影響。

対策：

v0.2.3-robustで自動フォールバック（polling）

iOS設定 → 位置情報サービス → Safari(or PWA) を 「使用中のみ許可」＋「正確な位置情報 ON」

低電力モード OFF、**屋外（空が開けた場所）**で再試行

それでも不安定ならChromeで比較／端末再起動

C. ビジュアルの中央ラインが途中で消える／横ズレが常に0.00
原因：AB距離<5m のときは向きが不安定なため、横ズレ計算を意図的に停止。

対策：AとBは10〜30m離して取り直す。

D. 精度が高まらない（>20〜30mが続く）
原因：屋内や遮蔽物、端末の初期化直後など。

対策：屋外で数十秒待つ／ダッシュボード上に置く／移動しながら再取得。

備考：スマホGPSは実用上**±数m〜十数m**。狭いスワスでは“目安”用途に留まる。

5) デプロイ運用（GitHub Pages）
配置：/agri_line/ などフォルダ単位で置くと、SWの影響を切り分けやすい。

確認：Settings → Pages → Source が、実際の配置と一致しているか。

キャッシュ破り：?v=timestamp を習慣化。

PWA：更新時は削除→再追加。

6) 画面の見方（ヘッダー）
精度：推定位置の誤差（小さいほど良い）

速度：直近の位置差から算出

更新: Hz：1秒あたりの位置更新回数（1〜2Hzが目安）

A→現在距離：A点から現在地までの距離（移動確認用）

AB距離：A〜Bの間隔（5m以上に）

7) これからの改善TODO
ロバスト化：フォールバックの閾値/間隔の最適化、計測開始の自動化オプション

外部GNSS：Bluetooth/NMEA入力（iOSはMFi/BLE SPPの実機検証）

視認性：描画レンジの自動スケール／ズレの履歴線表示

操作：音声ガイダンス強化、手袋向け大型UI

データ：作業記録/距離・面積の自動集計

8) 現場テスト時のチェックリスト（共有用）
 URLに ?v=タイムスタンプ を付けた（例：...?v=1733965...）

 計測開始を押している（停止ボタンが有効）

 精度 ≤ 15m／更新 ≈ 1–2Hz／速度が変化

 A→Bは10〜30m（ログでAB距離を確認）

 最寄ラインでターゲット合わせ

 うまく行かないとき：PWA再追加／Chrome比較／端末再起動