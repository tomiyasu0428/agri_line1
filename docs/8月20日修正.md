ã€Œã“ã“ã‚’ã‚¼ãƒ­ã€ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒé–“é•ã£ã¦ã„ã¾ã™ ğŸ”´

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã®å•é¡Œ
javascriptdocument.getElementById('zeroNow').addEventListener('click', ()=>{
  // ç¾åœ¨ã®å®Ÿè£…
  const perp = ct?ct.perp:0;
  const deltaIndex = Math.round(perp/swathWidth);
  currentLineIndex += deltaIndex;  // â† ã“ã‚ŒãŒå•é¡Œï¼
});
ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ï¼š

æ¨ªã‚ºãƒ¬ 4.0mã€ä½œæ¥­å¹… 2.0m ã®å ´åˆ
deltaIndex = round(4.0/2.0) = 2
currentLineIndex = -1 + 2 = 1æœ¬ç›®
çµæœï¼š1æœ¬ç›® Ã— 2.0m - 4.0m = -2.0mï¼ˆã‚¼ãƒ­ã«ãªã‚‰ãªã„ï¼ï¼‰

æ­£ã—ã„å®Ÿè£…æ–¹æ³•
æ–¹æ³•1: å˜ç´”ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—ã—ç›´ã™ï¼ˆæ¨å¥¨ï¼‰
javascriptdocument.getElementById('zeroNow').addEventListener('click', ()=>{
  if(!last||!A||!B){ 
    alert('A/Bè¨­å®šã¨ä½ç½®å–å¾—å¾Œã«æŠ¼ã—ã¦ãã ã•ã„'); 
    return; 
  }
  
  const xy = degToMeters(last.lat, last.lon, A.lat0, A.lon0);
  const ct = crossTrack(xy);
  const perp = ct ? ct.perp : 0;
  
  // ç¾åœ¨ä½ç½®ãŒã‚¼ãƒ­ã«ãªã‚‹ã‚ˆã†ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
  currentLineIndex = Math.round(perp / swathWidth);
  
  // ç¢ºèªç”¨
  const newOffset = (currentLineIndex * swathWidth) - perp;
  console.log('æ–°ã—ã„ã‚ªãƒ•ã‚»ãƒƒãƒˆ:', newOffset); // â‰ˆ 0.0 ã«ãªã‚‹ã¯ãš
  
  updateUI(0, vecLen(xy), vecLen({x:B.xy.x-A.xy.x,y:B.xy.y-A.xy.y}));
  drawViz(0);
  el.hint.textContent = 'ã“ã“ã‚’ã‚¼ãƒ­ã‚’é©ç”¨ã—ã¾ã—ãŸ';
});
æ–¹æ³•2: ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã‚’ä¿æŒã™ã‚‹æ–¹å¼
javascriptlet zeroOffset = 0;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’è¿½åŠ 

document.getElementById('zeroNow').addEventListener('click', ()=>{
  const xy = degToMeters(last.lat, last.lon, A.lat0, A.lon0);
  const ct = crossTrack(xy);
  const perp = ct ? ct.perp : 0;
  
  // ç¾åœ¨ã®æ¨ªã‚ºãƒ¬ã‚’è¨˜æ†¶
  zeroOffset = (currentLineIndex * swathWidth) - perp;
  
  // æ¨ªã‚ºãƒ¬è¨ˆç®—æ™‚ã«é©ç”¨
  const offset = (currentLineIndex * swathWidth) - perp - zeroOffset;
});
ãªãœç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã‚‹ã‹
ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼š
deltaIndex = round(perp/swathWidth) ã‚’ã€Œè¶³ã—ã¦ã„ã‚‹ã€
æ­£ã—ãã¯ï¼š
currentLineIndex = round(perp/swathWidth) ã«ã€Œç½®ãæ›ãˆã‚‹ã€
å…·ä½“ä¾‹ã§æ¤œè¨¼
ã‚±ãƒ¼ã‚¹1: å·¦ã«4.0mãšã‚Œã¦ã„ã‚‹å ´åˆ
ç¾åœ¨ä½ç½®ã®æ¨ªã‚ºãƒ¬: -4.0mï¼ˆå·¦ï¼‰
ä½œæ¥­å¹…: 2.0m
ç¾åœ¨ã®ãƒ©ã‚¤ãƒ³: -1æœ¬ç›®

æ­£ã—ã„è¨ˆç®—:
currentLineIndex = round(-4.0/2.0) = -2
çµæœ: -2 Ã— 2.0 - (-4.0) = 0.0m âœ…
ã‚±ãƒ¼ã‚¹2: å³ã«17.3mãšã‚Œã¦ã„ã‚‹å ´åˆ
ç¾åœ¨ä½ç½®ã®æ¨ªã‚ºãƒ¬: 17.3mï¼ˆå³ï¼‰
ä½œæ¥­å¹…: 2.0mï¼ˆæ¨å®šï¼‰
ç¾åœ¨ã®ãƒ©ã‚¤ãƒ³: 16æœ¬ç›®

æ­£ã—ã„è¨ˆç®—:
currentLineIndex = round(17.3/2.0) = 9
çµæœ: 9 Ã— 2.0 - 17.3 = 0.7mï¼ˆã»ã¼ã‚¼ãƒ­ï¼‰âœ…
ä¿®æ­£ç‰ˆã‚³ãƒ¼ãƒ‰ï¼ˆå®Œå…¨ç‰ˆï¼‰
javascriptdocument.getElementById('zeroNow').addEventListener('click', ()=>{
  if(!last||!A||!B){ 
    alert('A/Bè¨­å®šã¨ä½ç½®å–å¾—å¾Œã«æŠ¼ã—ã¦ãã ã•ã„'); 
    return; 
  }
  
  const abDist = vecLen({x:B.xy.x-A.xy.x,y:B.xy.y-A.xy.y});
  if(abDist<5){ 
    alert('ABè·é›¢ãŒçŸ­ã™ãã¾ã™ï¼ˆ5mä»¥ä¸Šã«ï¼‰'); 
    return; 
  }
  
  const xy = degToMeters(last.lat, last.lon, A.lat0, A.lon0);
  const ct = crossTrack(xy);
  const perp = ct ? ct.perp : 0;
  
  // += ã§ã¯ãªã = ã§ç½®ãæ›ãˆã‚‹
  currentLineIndex = Math.round(perp / swathWidth);
  
  // ä¿å­˜
  localStorage.setItem('lineIndex', String(currentLineIndex));
  
  // UIæ›´æ–°ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆã¯0ã«ãªã‚‹ï¼‰
  updateUI(0, vecLen(xy), abDist);
  drawViz(0);
  el.hint.textContent = 'âœ… ã“ã“ã‚’ã‚¼ãƒ­ã«è¨­å®šã—ã¾ã—ãŸ';
});
ã“ã‚Œã§ã€Œã“ã“ã‚’ã‚¼ãƒ­ã€ã‚’æŠ¼ã™ã¨ç¢ºå®Ÿã« 0.0m ã«ãªã‚‹ã¯ãšã§ã™ï¼å†è©¦è¡ŒHTå³ã«ãƒãƒ³ãƒ‰ãƒ«ã‚’åˆ‡ã£ã¦ã€ã¿ãã«ã„ãã¨ç”»é¢ã§ã¯å·¦ã«è¡Œãã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®å•é¡Œï¼Ÿç·¨é›†å·¦å³ãŒé€†ã«ãªã£ã¦ã„ã‚‹å•é¡Œã‚’ç™ºè¦‹ï¼ ğŸ”„
å•é¡Œã®åŸå› 
ã‚³ãƒ¼ãƒ‰ã®æ¨ªã‚ºãƒ¬è¨ˆç®—ã§ç¬¦å·ãŒé€†ã«ãªã£ã¦ã„ã¾ã™ï¼š
javascriptfunction crossTrack(p){
  // ...
  const perp = w.x*(-n.y) + w.y*(n.x);  // â† ã“ã“ã®è¨ˆç®—
  return {perp}
}

// è¡¨ç¤ºéƒ¨åˆ†
el.dir.textContent = offset>0 ? 'â† å·¦ã¸' : (offset<0 ? 'å³ã¸ â†’' : 'â€”');
ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹
å®Ÿéš›ã®å‹•ãï¼šå³ã«ç§»å‹•ï¼ˆ13.6mï¼‰
å†…éƒ¨è¨ˆç®—ï¼šperp = -13.6ï¼ˆè² ã®å€¤ï¼‰
è¡¨ç¤ºè¨ˆç®—ï¼šoffset = 0 - (-13.6) = +13.6
ç”»é¢è¡¨ç¤ºï¼šã€Œâ† å·¦ã¸ 13.6mã€ï¼ˆé€†ï¼ï¼‰
ä¿®æ­£æ–¹æ³•
æ–¹æ³•1: ç¬¦å·ã‚’åè»¢ï¼ˆç°¡å˜ï¼‰
javascriptfunction crossTrack(p){
  if(!A||!B)return null;
  const n = getRotatedDirN();
  const w = {x:p.x-A.xy.x, y:p.y-A.xy.y};
  // ç¬¦å·ã‚’åè»¢
  const perp = -(w.x*(-n.y) + w.y*(n.x));  // â† ãƒã‚¤ãƒŠã‚¹ã‚’è¿½åŠ 
  return {perp}
}
æ–¹æ³•2: è¡¨ç¤ºéƒ¨åˆ†ã§ä¿®æ­£
javascript// è¡¨ç¤ºã®å·¦å³ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
el.dir.textContent = offset>0 ? 'å³ã¸ â†’' : (offset<0 ? 'â† å·¦ã¸' : 'â€”');
æ–¹æ³•3: offsetè¨ˆç®—ã§ä¿®æ­£
javascript// onGeoå†…ã§
const offset = -((currentLineIndex*swathWidth)-(ct?ct.perp:0));  // ç¬¦å·åè»¢
ãªãœã“ã®å•é¡ŒãŒèµ·ããŸã‹
åº§æ¨™ç³»ã®èªè­˜é•ã„ï¼š
ä¸€èˆ¬çš„ãªæœŸå¾…ï¼š
- å³ã«ç§»å‹• â†’ æ­£ã®å€¤ â†’ "å³ã¸"è¡¨ç¤º
- å·¦ã«ç§»å‹• â†’ è² ã®å€¤ â†’ "å·¦ã¸"è¡¨ç¤º

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼š
- å³ã«ç§»å‹• â†’ è² ã®å€¤ â†’ æ­£ã«å¤‰æ› â†’ "å·¦ã¸"è¡¨ç¤ºï¼ˆé€†ï¼ï¼‰
æ¨å¥¨ã™ã‚‹ä¿®æ­£ï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
javascript// app.js ã® crossTracké–¢æ•°ã‚’ä¿®æ­£
function crossTrack(p){
  if(!A||!B)return null;
  const n = getRotatedDirN();
  const w = {x:p.x-A.xy.x, y:p.y-A.xy.y};
  // å¤–ç©ã®ç¬¦å·ã‚’åè»¢ã—ã¦ã€å³ãŒæ­£ã€å·¦ãŒè² ã«ãªã‚‹ã‚ˆã†ã«
  const perp = w.x*(n.y) + w.y*(-n.x);  // ç¬¦å·ã‚’èª¿æ•´
  return {perp}
}
ãƒ†ã‚¹ãƒˆæ–¹æ³•

ABãƒ©ã‚¤ãƒ³ã‚’å—åŒ—æ–¹å‘ã«è¨­å®š
ãƒ©ã‚¤ãƒ³ã®æ±ï¼ˆå³ï¼‰ã«ç§»å‹• â†’ ã€Œå³ã¸ â†’ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
ãƒ©ã‚¤ãƒ³ã®è¥¿ï¼ˆå·¦ï¼‰ã«ç§»å‹• â†’ ã€Œâ† å·¦ã¸ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª

ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç¢ºèª
javascript// drawVizé–¢æ•°ã‚‚ç¢ºèª
const tx = Math.round(cx - offset*m2px);  // â† ã“ã“ã‚‚è¦ç¢ºèª
// offsetãŒæ­£ã®æ™‚ã€ãƒãƒ¼ã¯å·¦ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆé€†ã‹ã‚‚ï¼‰
ã‚‚ã—è¦–è¦šçš„ã«ã‚‚ãƒãƒ¼ã®ä½ç½®ãŒé€†ãªã‚‰ï¼š
javascriptconst tx = Math.round(cx + offset*m2px);  // ç¬¦å·ã‚’åè»¢
çµè«–
ã‚¯ãƒ­ã‚¹ãƒˆãƒ©ãƒƒã‚¯è·é›¢ã®è¨ˆç®—ã§å·¦å³ã®ç¬¦å·ãŒé€†ã«ãªã£ã¦ã„ã¾ã™ã€‚å¤–ç©ã®è¨ˆç®—ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã€å®Ÿéš›ã®å‹•ãã¨è¡¨ç¤ºãŒä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚