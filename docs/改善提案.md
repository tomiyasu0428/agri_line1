# StraightBar Lite – Visual 改善提案（v0.2.3-robustベース）

本ドキュメントは現状コードとREADME/USAGE/現場メモを踏まえた課題と改善方針のまとめです。現場での安定性・視認性・操作性の向上を主目的とします。

## 概要
- 目的: 屋外作業の手動直進を補助。ABラインに対する横ズレを大きく・シンプルに見せる。
- 技術: 完全クライアント（Geolocation API、Canvas、PWA/manifest）。iOSの更新停止対策として watch → polling の自動フォールバックを実装。
- 現状の主な制約: スマホGPSの精度（±数m〜十数m）、HTTPS/localhost必須、AB<5mで横ズレ計算停止。

---

## 課題と改善方針（優先度順）

### 1. 位置取得の安定化/フォールバック最適化（高）
- 現状: 5秒無更新→毎秒ポーリングへ移行、連続10回成功でwatch復帰。
- 課題: エラー理由の不透明さ、状況に応じた間隔・復帰条件の最適化不足。
- 改善提案:
  - エラー種別（PERMISSION_DENIED、POSITION_UNAVAILABLE、TIMEOUT）ごとの扱い分岐とUI明示。
  - ポーリング間隔の適応（1.0→1.5sなど）、復帰条件を「時間ベース＋成功率ベース」併用に。
  - リトライ上限とユーザー通知（トースト/ヘッダー）を追加。

### 2. 状態保存の一貫性（高）
- 現状: currentLineIndex が操作（prev/next/snap）で更新されても永続化されない。
- 改善提案: ライン変更時に常に localStorage へ保存。swath 変更時はヒント/数値も即更新。

### 3. A/BのバリデーションとUX（高）
- 現状: AB<5mでもBが保持され、誤認の恐れ。
- 改善提案: AB<5mならBを無効化（未設定扱い）または明確な赤警告。「B点を再設定してください」を常時表示。必要なら自動解除。

### 4. 許可/権限ガイダンス（高）
- 改善提案: navigator.permissions 等で未許可を先読みし、iOS/Android別の設定方法をUIに表示。未許可時は操作ボタン無効化＋ガイド表示。

### 5. バッテリー/発熱対策（高）
- 改善提案: 非移動時（速度低/位置変化小）は描画や音声を間引き、ポーリング間隔を延長。Wake Lockは「可視かつ計測中のみON」を徹底。

### 6. UX/視認性（中）
- Driveモードしきい値:
  - 現状: Wide/Normal のみ。
  - 改善: カスタム数値入力、速度依存の自動可変、色弱配慮の配色（赤/緑依存低減）。
- 情報表示の整合性:
  - ライン/作業幅変更時に UI（ヒント/数値）を必ず更新。
  - 「A/Bクリア」で currentLineIndex も 0 リセット。
- 非ブロッキング通知:
  - alert() の多用を廃止し、トースト/バナー通知に置換。

### 7. 性能/描画（中）
- 改善提案:
  - 描画は requestAnimationFrame に集約（GPSイベントは最新値を更新するだけ）。
  - 低Hz/小型端末ではキャンバス解像度・描画要素を簡略化。
  - 最小キャンバス幅（現在600px相当）の見直し。

### 8. 計算の安定化（中）
- 改善提案:
  - 低速時の方位ノイズ対策にローパス/カルマン導入（resetKalman の実装）。
  - A/B短距離時の方向不定対策をUIでより強調。

### 9. PWA/配布運用（中）
- 現状: 検証のためSWなし。
- 改善提案:
  - 本番はSWで版付きキャッシュ運用（キャッシュ名にバージョン、旧キャッシュ破棄）。
  - 更新検知→リロード案内。maskableアイコン、Apple touch icon、iOS向けmetaを追加。
  - 初回チュートリアル/ダイアログで「HTTPS/localhost必須」と権限設定を周知。

### 10. 堅牢性/コード品質（中）
- 改善提案:
  - Geolocationの各エラーコードでUI/リトライ戦略を分岐。
  - localStorage失敗（プライベートモード）時のフォールバックをtry/catchで徹底。
  - 幾何/変換/スナップ/フィルタをモジュール化、TypeScript化を検討。
  - デスクトップ用のモック位置“デモモード”とユニットテスト（AB距離、クロストラック、スナップ）を整備。

---

## すぐに着手できる小改修（具体例）
1. ライン操作時の永続化
   - prev/next/snap の各ハンドラ末尾で `localStorage.setItem('lineIndex', String(currentLineIndex))` を実行。
2. swath変更時のUI即時更新
   - `updateUI(...)` を呼び、ヒント/数値/描画を一貫更新。
3. エラー可視化
   - watch/getCurrentPosition の error.code ごとにヘッダーへ短文で対処法を表示（許可/屋外/正確な位置情報ON）。
4. 非ブロッキング通知
   - alert() をトーストに置換。AB<5m時はBを無効化し、ヒントを赤表示。
5. 描画スロットリング
   - rAFループ導入、再描画フラグ方式に。端末負荷を低減。

---

## 中期の機能拡張
- 自動最寄ラインスナップ（閾値＋ヒステリシス、手動併用）。
- 可視レンジ自動スケール（±mを段階的に可変）。
- 走行記録/CSVエクスポート（時刻, lat, lon, offset, speed, acc, mode）。
- 外部GNSS（BLE/NMEA）入力（Android）とソース種別の表示。
- 多言語化（JP/EN切替）。

---

## セキュリティ/プライバシ
- 設計: クライアント完結（位置データはサーバ送信しない）。
- 改善: 将来の記録/エクスポートはローカル保存を基本、外部送信時は明示的同意を取得。

---

## 期待効果
- 現場での「止まらない・わかりやすい・迷わない」を強化。
- バッテリー/発熱の抑制と、端末/環境差の影響低減。
- 今後の外部GNSSや記録系の拡張に向けた基盤強化。
