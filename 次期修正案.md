# StraightBar - 基準線&キャリブ仕様(統合版v1)

**対象機能:** 『ここをゼロ』、『クイックキャリブ(短距離)』、『走行中の自動回転補正』。運転時の迷いを減らし、ABの向き誤差を自動で潰す。

---

## 次にやること(優先度高)
- ① クイックキャリブ (12-20m) を実装: 走り始めて即“平均方向”でABを直線化。
- ② 走行中の自動回転補正: 横ズレの傾きから△を学習し、少しずつABを回す。
- ③ 既存機能のログ/イベント統一 (zero_snap/auto_calibrated/auto_rotate)。

---

## 1) 概要/前提
- ABライン=基準直線(A→B)。横ズレ=現在位置からABへの符号付き最短距離(右+)。
- 単位/座標/時間: SI (m, m/s, m²) / WGS84 (lat, lon) / ISO8601 UTC。
- 推奨ガード: 速度≥2km/h、精度≤10m。低速/停止中は方位を移動ベクトルから推定。
 - シンプル方針: ABの確立は「短距離の実走（推奨12〜20m）」のみで行う。ここからAB（即席AB生成）は採用しない。

---

## 2) ここをゼロ ― 現在位置を基準線上に合わせる
- **UX:** ワンタップ→2秒ロック→トースト表示。
- **平行ライン運用:** 横ズレ/スワスで丸め、本数ぶんターゲットライン番号をシフト。
- **固定AB運用:** ABを平行移動 (地図タイルや開始位置のズレ吸収)。
- **ログ:** `zero_snap {ts, delta_m, mode:'shift_index'|'parallel_shift', accuracy_m}`

---

## 3) クイックキャリブ(12-20m) - ABの向きを即平均化
- **UX:** 走り始めると『学習中』→『方位合わせ完了(良/可/要再取得)』。ボタン不要。
- **採用条件:** 速度≥2km/h、精度≤10m。急旋回は外れ値。
- **ロジック:** 移動ベクトルのロバスト平均→最小二乗直線→方位推定→B再計算→必要なら『ここをゼロ』。
- **しきい値:** 距離12-20m (外部GNSSは短め、スマホ単体は長め)。R2≥0.90 & ゆらぎ≤3なら確定。
- **ログ:** `auto_calibrated {ts, used_distance_m, heading_deg, quality:{r2,jitter_deg}}`

---

## 4) 走行中の自動回転補正 - 横ズレ傾きから△θを学習
- **目的:** ABの向き誤差△を走行中に自動補正。
- **ロジック:** 窓幅30-100mで横ズレ量を回帰→傾きs→△θ ~ arcsin(s)。指数平滑で徐々に反映 (例 α=0.2)。
- **順序:** ①『ここをゼロ』→ ②回転補正 → ③必要なら再ゼロ。
- **合格:** |s| < 0.01 (100mで±1m以内)。上限: 1回≤1°、累積±5°。
- **ログ:** `auto_rotate {ts, slope_s, delta_theta_deg, window_m }`

---

## 5) メトリクス/QAチェック
- **横ズレ標準偏差:** スマホ単体で±0.3-0.6m (直線路、速度≥3km/h)。
- **傾きs:** s < 0.01。往復でも傾き再発なし。
- **品質スコアをUI表示:** (R2/角度ゆらぎ/使用距離)。

## 6 アプリのm表記変更
- 現在の0.00→0.0に変更。

---
---

## 【後回し/将来検討する機能】

### （採用しない）ここからAB - 現在地+進行方向から即席AB
シンプル維持のため不採用。ABは短距離の実走（12〜20m）で確立する。

### (旧4) [cite_start]マップでAB - 地図上で直線を引く [cite: 21]
- [cite_start]**地図モード:** 2タップでA/B確定or長押しドラッグで方位指定。距離/方位をライブ表示。 [cite: 22]
- [cite_start]**便利:** 平行ライン自動生成 (±N本)、方位スナップ (1°/5°/10°、NS/EW)。 [cite: 23]
- [cite_start]**実地合わせ:** 『ここをゼロ』で平行移動。 [cite: 24]
- [cite_start]**ログ:** `ab_created_on_map {ts, A, B, bearing_deg, length_m, snap_used }` [cite: 25]

## 6) データ項目/イベント/MCP連携
- **CSV (1Hz):** `ts, lat, lon, acc_m, speed_mps, heading_deg, offset_m`。
- **AB JSON:** `{id, A{lat, lon}, B{lat, lon}, bearing_deg, length_m, swath_m, tolerance{ok_cm,warn_cm}, source }`
- **イベント:** `zero_snap/ab_created_from_here/ab_created_on_map/auto_calibrated/auto_rotate`
- **MCP/REST:** `/sessions`, `/sessions/{id}`, `/track.csv`, `/polygon.geojson`, `/events` (読み取り専用, X-API-Key)。